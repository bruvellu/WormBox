/* WormBox */

macro "Unused Tool - " {}
macro "Load ROI for image Action Tool - C520D4bDa5DaeC210Da7Ca53D5cD5dD7bC631D5eC420DafC777D66C530D99Da4C420D22D31D4eD5fD91D9aDa2Da3Da6DcaCd75D6dC842D49DadDcdDdeC222D56CaaaD47C520D02D06D11D18D20D3fD9fDa0Db1Db8DdaDefDfcC410D26Cb74D5aC842D4aD5bD8aD97C520D39D3aD3bCd86D33C631D41D6fD7fD81D8fD98DbfDcbDccDcfDdfDeeCd75D59D69D6cD79D7cD7dD85D86D87D8cD8dD95D9cC953D6bD8eC444D46CcccD67C410D4cD50D70Ca63D89C731D25Cd85D94C531DedC952D6eCda9D74C420D4dD60Cc75D42C842D32D51D71Cd97D43D53D63D73D83C953DbbCedcD75C310D14DfeC875D37C642D29D38C988D57Cda9D34D58Cc75D88D9dDabCd86D62D84CcccD65Cb64D7aDbcC842D92D9eDbeCc86D72C953D24D8bD9bCebaD77Cc75D82D93DacCa53D7eDceCeeeD35D64C631DbaDddC888D55CcbbD36Cc74D6aCb64D96DbdC731D23Cd86D78C853D61CebaD44CfddD76Cb98D48CdccD45Cc86D52CecbD54D68C741Daa" {
    loadWorm();
}
macro "Load ROI for image [1]" {
    loadWorm();
}

macro "Save image data Action Tool - C622 T0808s T5808a Ta808v Tc808e P2c3e4d5c6f7d8e9caebdcfddecff0" {
    saveWorm();
}
macro "Save image data [2]" {
    saveWorm();
}

macro "Count a structure Action Tool - C222 T0807c T4807o T7807u Tb807n Tf807t P2c3e4d5c6f7d8e9caebdcfddecff0" {
    loadWorm();
    count();
    saveWorm();
}
macro "Count a structure data [3]" {
    loadWorm();
    count();
    saveWorm();
}

macro "Add extra landmarks Action Tool - CadaD36D93C7a6D18CfffD00D01D02D03D04D05D06D07D08D09D0aD0bD0cD0dD0eD0fD10D11D12D13D1cD1dD1eD1fD20D21D22D2dD2eD2fD30D31D3eD3fD40D4fD50D57D58D5fD60D67D68D6fD70D75D76D77D78D79D7aD7fD80D85D86D87D88D89D8aD8fD90D97D98D9fDa0Da7Da8DafDb0DbfDc0Dc1DceDcfDd0Dd1Dd2DddDdeDdfDe0De1De2De3DecDedDeeDefDf0Df1Df2Df3Df4Df5Df6Df7Df8Df9DfaDfbDfcDfdDfeDffC6a5D2bDc2CbdaD43D92C8c7D6dDb3C483D5eCbdaD26D28D34D3aD4bD5cDc5C7c6D59C7b5DabDbaCcecDa3C9c8D6cD9cC383D8eDe9CbdaDacDbbDcaC7b6D3bD66Da2Dc4C7a5D1aCbebD27D63C8c8D46D74C594Dd4C8b7D9dDd9C7b6D5bD6aDa6CdedD35Cad9D7dC382D9eDaeDbdDccDdbDeaC7b6D7cD8cDc8C6a5D96Db1DbcDcbCbeaDb4C8c7D38D65C594D4dDe4C8b7D14D23D32D41D51C7b5D5aD6bD7bD99D9aDa9Db6Db7Db8Db9CcecD82C9d8Dc6C483D6eDdaDe6De7C8b7D15D24D33D42C7a6D19D91Da1CcecD62C9d8D37D39D55D84D94C595Dc3C8c7D48CdfdD44Cad9Dd7Dd8C7b6D17C6a5D2aC8c7D47D56D95C494D4eDe5C7c6D49Da5Db5Dc7C9c8D29C383De8C6b5D8bD9bDaaC9c8Dc9C594D3cD3dDd3Cad9D45D83C9c8D25Dd6C594D5dDd5CdecD72Cac9D52D8dC695D2cCefdD53Cad9D73C7b6D4cD81C6a5D69C7c6D4aC9d9D54C8b6D16D61D71C6a5D1bDb2C483D7eDadC8d8Da4C9c8D64" {
}
macro "Add extra landmarks [5]" {
}

// Fiji only (or ImageJ+Jython).
macro "Analyze data Action Tool - C222 T0807a T4807n T7807a Tb807l Tf807t P2c3e4d5c6f7d8e9caebdcfddecff0" {
    run("WormBox Analyzer");
}
macro "Analyze data [5]" {
    run("WormBox Analyzer");
}


//TODO Write return values for all functions.

function getFilename(title) {
    /*
     * Parse window title to get filename without extension.
     *
     * Exit if filename has extra dots in it.
     */
    temp = split(title, ".");
    listSize = temp.length;
    if ( listSize > 2 ) {
        exit("Filename should not have \".\" characters (except preceding the extension):\n \n" + title + "\n \nPlease rename the file and try to load WormBox again.");
    }
    name = temp[0];
    return name;
}

function getExtension(title) {
    /*
     * Parse window title to get the filename extension.
     */
    temp = split(title, ".");
    extension = temp[temp.length-1];
    if (extension != "tif" || extension != "TIF") {
        showMessage("Warning", title + " is not a TIFF file. After measurements, it \nwill be saved as .tif to keep scale settings.");
    }
    return extension;
}

function isScaled(title) {
    /*
     * Check if a scale has been set on the current image.
     *
     * If not, ask user to interact.
     */
    selectImage(title);
    getPixelSize(unit, pixelWidth, pixelHeight, pixelDepth);
    if (pixelWidth == 1 || pixelWidth == 1 || unit == "pixels" || unit == "" || unit == " ") {
        setTool("line");
        waitForUser("Critical issue!", "It looks like " + title + " scale \nis not set or the unit name is missing:\n \nPixel width: " + pixelWidth + "\nPixel height: " + pixelHeight + "\nPixel depth: " + pixelDepth + "\nUnit: " + unit + "\n \nWith this window open, set the scale using \nAnalyse > Set Scale... and then hit OK to continue.");
        getPixelSize(unit, pixelWidth, pixelHeight, pixelDepth);
        if (pixelWidth == 1 || pixelWidth == 1 || unit == "pixels" || unit == "" || unit == " ") {
            exit("Scale was not set. Impossible to continue... \nSet the scale before running WormBox again. Bye!");
        }
    }
}

function count() {
    /*
     * Workflow to count structures in the images.
     */
    run("Select None");
    setTool("multipoint");
    waitForUser("Without closing this window:\n \n1. Count the number of structures by clicking on the image.\n \n2. When finished, press OK and give a name for this structure.");
    setKeyDown("alt");
    roiManager("Add");
}

function getHeightUnit() {
    /*
     * Fill default landmarks within the image dimensions.
     */
    height = getHeight();
    hUnit = height / n;
    return hUnit - hUnit/2;
}

function loadWorm() {
    /*
     * Should be run after image is opened.
     *
     * Check if the image was scaled, ask user if not.
     *
     * Try to load the landmarks: image ROI, default ROI, or get input from 
     * user to build a default ROI; in this order.
     *
     * Let user modify landmarks.
     */

    // Necessary to load ROI Manager with Edit Mode activated.
    requires("1.45m");

    // Read window title to get the image name.
    title = getTitle();

    // Check if image is properly scaled.
    isScaled(title);

    // Get extension from filename.
    extension = getExtension(title);

    // Get filename without extension.
    name = getFilename(title);

    // Get image folder.
    dir = getDirectory("image");

    // Define full image path without extension.
    namePath = dir + name;

    // Define ROI file for image.
    roiset = name + ".zip";

    // Define path to ROI file.
    roisetPath = dir + roiset;

    // Define default ROI template filename.
    roiTemplate = "RoiSet.zip";

    // Define default ROI template path.
    roiTemplatePath = dir + roiTemplate;

    // Clear selection before anything.
    run("Select None");

    // Load ROI Manager with "show all" and "name as labels".
    run("ROI Manager...");
    roiManager("UseNames", "true");
    roiManager("Show All");
    roiManager("Show All with labels");

    // Try to open image roi, then default template, else provide a new 
    // template.
    if (File.exists(roisetPath)) {
        // Load image ROI file "filename.zip"
        roiManager("Open", roisetPath);
    } else {
        if (File.exists(roiTemplatePath)) {
            // Load default template "RoiSet.zip"
            roiManager("Open", roiTemplatePath);
        } else {
            // Call default template builder.
            Dialog.create("Create a template");
            Dialog.addNumber("Number of landmarks", 10);
            Dialog.show();
            // Get number of landmarks from the user.
            n = Dialog.getNumber();
            // Get image dimensions to calculate unit.
            width = getWidth();
            wUnit = width / n;
            hUnit = getHeightUnit();
            //XXX Small image dimensions might overflow landmarks.
            for (i=0; i<n; i++) {
                makePoint(wUnit, hUnit*(i+1));
                roiManager("Add");
                roiManager("Select", i);
                roiManager("Rename", i+1);
            }
            roiManager("Deselect");
            roiManager("Save", roiTemplatePath);
        }
    }
}

function saveWorm() {
    /*
     * Save landmarks to ROI and to a text file for posterior analysis.
     *
     * Argument "meristic" can be "true" to prompt user to count structures or 
     * "false" to skip this prompt.
     */

    // Set decimal to 3.
    run("Set Measurements...", "display redirect=None decimal=3");

    // Set defaults for data output with numbered rows (copy_row).
    run("Input/Output...", "jpeg=75 gif=-1 file=.txt use copy_row");

    // Read window title to get the image name.
    title = getTitle();

    // Parsing title to purge extension.
    name = getFilename(title);

    // Get image folder.
    dir = getDirectory("image");

    // Define full image path without extension.
    namePath = dir + name;

    //XXX Make WormBox_Analyzer.py read ROI ZIP directly, instead of TXT.
    filePath = namePath + "_data.txt";

    //// If it is a regular saving, ask user to count (meristic=true).
    //if (meristic == true) {
    //    counting = getBoolean("Do you want to count structures?");
    //    if (counting == true) {
    //        count();
    //    }
    //}

    // Deselect items on the list.
    roiManager("Deselect");

    // Save ROI for the image.
    roiManager("Save", namePath + ".zip");

    // Calculate measurements.
    roiManager("Measure");

    // Focus Results window
    selectWindow("Results");

    // Finally save measurements.
    saveAs("measurements", filePath);

    // Disable ROI Manager points.
    roiManager("Show None");

    // Close windows.
    selectWindow("Results");
    run("Close");
    selectWindow("ROI Manager");
    run("Close");

    // Select opened window to save.
    selectWindow(title);
    // Save image as TIFF (makes TIF >> tif).
    //XXX Ideally it should preserve the extension.
    saveAs("tiff", namePath);
}
